name: Build WDA IPA (ShieldLib Protection)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Inject ShieldLib into WDA
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Install tools (ldid + insert_dylib)
        run: |
          curl -sL https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid_macosx_arm64 -o /usr/local/bin/ldid
          chmod +x /usr/local/bin/ldid
          echo "ldid installed"

          git clone --depth 1 https://github.com/tyilo/insert_dylib.git /tmp/insert_dylib
          cd /tmp/insert_dylib
          xcodebuild -project insert_dylib.xcodeproj -configuration Release -target insert_dylib
          cp build/Release/insert_dylib /usr/local/bin/insert_dylib
          chmod +x /usr/local/bin/insert_dylib
          echo "insert_dylib installed"

      # ══════════════════════════════════════════════════════
      # BUILD SHIELDLIB DYLIB (Pure Objective-C)
      # ══════════════════════════════════════════════════════
      - name: Build ShieldLib dylib
        run: |
          echo "═══ Building ShieldLib ═══"
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang -shared \
            -target arm64-apple-ios10.0 \
            -isysroot "$SDK_PATH" \
            -install_name @executable_path/hhhhsd.dylib \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework SystemConfiguration \
            -fobjc-arc \
            -O2 \
            -o ShieldLib.dylib \
            ShieldLib/ShieldLib.m

          echo "ShieldLib.dylib built!"
          ls -lh ShieldLib.dylib
          file ShieldLib.dylib
          otool -L ShieldLib.dylib

      # ══════════════════════════════════════════════════════
      # PATCH IPA — CHỈ inject ShieldLib, KHÔNG thay đổi WDA gốc
      # ══════════════════════════════════════════════════════
      - name: Inject ShieldLib into WDA IPA
        run: |
          echo "═══ Injecting ShieldLib into WDA_TrollStore.ipa ═══"
          echo "★ KHÔNG thay thế WebDriverAgentLib gốc — giữ nguyên WDA hoạt động"

          BASE_IPA="base/WDA_TrollStore.ipa"
          if [ ! -f "$BASE_IPA" ]; then
            echo "ERROR: base/WDA_TrollStore.ipa not found!"
            exit 1
          fi
          echo "Base: $BASE_IPA ($(du -sh "$BASE_IPA" | cut -f1))"

          # Extract
          mkdir -p work && cd work
          unzip -o "../$BASE_IPA"

          APP_DIR="Payload/WebDriverAgentRunner-Runner.app"
          MAIN_BIN="$APP_DIR/WebDriverAgentRunner-Runner"

          # ── 1. Copy ShieldLib vào app bundle ──
          echo ""
          echo "═══ Step 1: Copy ShieldLib ═══"
          cp ../ShieldLib.dylib "$APP_DIR/hhhhsd.dylib"
          echo "ShieldLib.dylib → hhhhsd.dylib"
          ls -lh "$APP_DIR/hhhhsd.dylib"

          # ── 2. Inject LC_LOAD_DYLIB nếu cần ──
          echo ""
          echo "═══ Step 2: Inject LC_LOAD_DYLIB ═══"
          if otool -L "$MAIN_BIN" 2>/dev/null | grep -q "hhhhsd.dylib"; then
            echo "Already loads hhhhsd.dylib — skip"
          else
            echo "Before:"
            otool -L "$MAIN_BIN" | head -10
            insert_dylib --strip-codesig --inplace \
              "@executable_path/hhhhsd.dylib" \
              "$MAIN_BIN"
            echo ""
            echo "After:"
            otool -L "$MAIN_BIN" | head -10
            echo "LC_LOAD_DYLIB INJECTED!"
          fi

          # ── 3. Fakesign tất cả binaries ──
          echo ""
          echo "═══ Step 3: Fakesign ═══"

          cat > /tmp/ent.plist << 'XMLEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>platform-application</key>
            <true/>
            <key>com.apple.private.security.no-container</key>
            <true/>
            <key>get-task-allow</key>
            <true/>
            <key>keychain-access-groups</key>
            <array>
              <string>com.icontrol.shield</string>
            </array>
          </dict>
          </plist>
          XMLEOF

          # Sign main binary + ShieldLib
          ldid -S/tmp/ent.plist "$MAIN_BIN"
          echo "Signed: WebDriverAgentRunner-Runner"
          ldid -S/tmp/ent.plist "$APP_DIR/hhhhsd.dylib"
          echo "Signed: hhhhsd.dylib"

          # Sign all other binaries in app
          find "$APP_DIR" -name "*.dylib" -type f ! -name "hhhhsd.dylib" | while read f; do
            ldid -S/tmp/ent.plist "$f" 2>/dev/null && echo "Signed: $(basename $f)" || true
          done
          find "$APP_DIR" -path "*/Frameworks/*.framework/*" -type f ! -name "*.plist" ! -name "version.plist" | while read f; do
            ldid -S/tmp/ent.plist "$f" 2>/dev/null && echo "Signed: $(basename $f)" || true
          done
          XCTEST_BIN="$APP_DIR/PlugIns/WebDriverAgentRunner.xctest/WebDriverAgentRunner"
          [ -f "$XCTEST_BIN" ] && ldid -S/tmp/ent.plist "$XCTEST_BIN" && echo "Signed: WebDriverAgentRunner"
          WDALIB="$APP_DIR/PlugIns/WebDriverAgentRunner.xctest/Frameworks/WebDriverAgentLib.framework/WebDriverAgentLib"
          [ -f "$WDALIB" ] && ldid -S/tmp/ent.plist "$WDALIB" && echo "Signed: WebDriverAgentLib"

          # ── 4. Package IPA ──
          echo ""
          echo "═══ Step 4: Package IPA ═══"
          find Payload -type f | sort
          echo ""
          otool -L "$MAIN_BIN"
          zip -r -9 ../iPhoneControl_WDA.ipa Payload/
          cd ..
          echo ""
          echo "═══ DONE — IPA: $(du -sh iPhoneControl_WDA.ipa | cut -f1) ═══"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: iPhoneControl-WDA
          path: iPhoneControl_WDA.ipa
          retention-days: 90
