name: Build Custom WDA IPA

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build WDA IPA
    runs-on: macos-14

    steps:
      - name: Checkout WebDriverAgent
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Build WebDriverAgent
        run: |
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            CODE_SIGN_ENTITLEMENTS="" \
            ONLY_ACTIVE_ARCH=NO

      - name: Inject Custom App Icon
        run: |
          echo "═══ Injecting custom app icon ═══"

          # Find the built .app
          APP_PATH=$(find ./build -name "*.app" -path "*Release-iphoneos*" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found!"
            exit 1
          fi
          echo "App path: $APP_PATH"

          # Check if source icon exists
          if [ ! -f "1024x1024.png" ]; then
            echo "WARNING: 1024x1024.png not found in repo root, skipping icon injection"
            exit 0
          fi

          # Generate all required iOS icon sizes using sips (built-in macOS tool)
          echo "Generating icon sizes..."
          sips -z 40 40 1024x1024.png --out "$APP_PATH/AppIcon20x20@2x.png"
          sips -z 60 60 1024x1024.png --out "$APP_PATH/AppIcon20x20@3x.png"
          sips -z 58 58 1024x1024.png --out "$APP_PATH/AppIcon29x29@2x.png"
          sips -z 87 87 1024x1024.png --out "$APP_PATH/AppIcon29x29@3x.png"
          sips -z 80 80 1024x1024.png --out "$APP_PATH/AppIcon40x40@2x.png"
          sips -z 120 120 1024x1024.png --out "$APP_PATH/AppIcon40x40@3x.png"
          sips -z 120 120 1024x1024.png --out "$APP_PATH/AppIcon60x60@2x.png"
          sips -z 180 180 1024x1024.png --out "$APP_PATH/AppIcon60x60@3x.png"
          sips -z 76 76 1024x1024.png --out "$APP_PATH/AppIcon76x76@1x.png"
          sips -z 152 152 1024x1024.png --out "$APP_PATH/AppIcon76x76@2x.png"
          sips -z 167 167 1024x1024.png --out "$APP_PATH/AppIcon83.5x83.5@2x.png"

          # Update Info.plist to reference the icons
          PLIST="$APP_PATH/Info.plist"

          # Remove existing icon entries if any
          /usr/libexec/PlistBuddy -c "Delete :CFBundleIcons" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Delete :CFBundleIcons~ipad" "$PLIST" 2>/dev/null || true

          # Add iPhone icons
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon20x20" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon29x29" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon40x40" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon60x60" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon76x76" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon83.5x83.5" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:UIPrerenderedIcon bool true" "$PLIST"

          # Add iPad icons
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon20x20" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon29x29" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon40x40" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon60x60" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon76x76" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon83.5x83.5" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:UIPrerenderedIcon bool true" "$PLIST"

          echo "Icons injected successfully!"
          ls -la "$APP_PATH"/AppIcon*.png

      - name: Package IPA for TrollStore
        run: |
          APP_PATH=$(find ./build -name "*.app" -path "*Release-iphoneos*" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found!"
            exit 1
          fi
          echo "Found app: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r -9 iPhoneControl_WDA.ipa Payload/
          echo "IPA size: $(du -sh iPhoneControl_WDA.ipa | cut -f1)"

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iPhoneControl-WDA
          path: iPhoneControl_WDA.ipa
          retention-days: 90
