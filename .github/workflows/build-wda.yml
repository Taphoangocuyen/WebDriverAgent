name: Build Custom WDA IPA

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build WDA IPA
    runs-on: macos-14

    steps:
      - name: Checkout WebDriverAgent
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      # ── Install ldid for TrollStore fakesigning ──
      - name: Install ldid
        run: |
          echo "═══ Installing ldid ═══"
          # Download ldid from ProcursusTeam
          curl -sL https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid_macosx_arm64 -o /usr/local/bin/ldid
          chmod +x /usr/local/bin/ldid
          ldid 2>&1 | head -1 || echo "ldid installed"

      - name: Build WebDriverAgent
        run: |
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            CODE_SIGN_ENTITLEMENTS="" \
            ONLY_ACTIVE_ARCH=NO

      - name: Inject Custom App Icon
        run: |
          echo "═══ Injecting custom app icon ═══"

          APP_PATH=$(find ./build -name "*.app" -path "*Release-iphoneos*" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found!"
            exit 1
          fi
          echo "App path: $APP_PATH"

          if [ ! -f "1024x1024.png" ]; then
            echo "WARNING: 1024x1024.png not found in repo root, skipping icon injection"
            exit 0
          fi

          echo "Generating icon sizes..."
          sips -z 40 40 1024x1024.png --out "$APP_PATH/AppIcon20x20@2x.png"
          sips -z 60 60 1024x1024.png --out "$APP_PATH/AppIcon20x20@3x.png"
          sips -z 58 58 1024x1024.png --out "$APP_PATH/AppIcon29x29@2x.png"
          sips -z 87 87 1024x1024.png --out "$APP_PATH/AppIcon29x29@3x.png"
          sips -z 80 80 1024x1024.png --out "$APP_PATH/AppIcon40x40@2x.png"
          sips -z 120 120 1024x1024.png --out "$APP_PATH/AppIcon40x40@3x.png"
          sips -z 120 120 1024x1024.png --out "$APP_PATH/AppIcon60x60@2x.png"
          sips -z 180 180 1024x1024.png --out "$APP_PATH/AppIcon60x60@3x.png"
          sips -z 76 76 1024x1024.png --out "$APP_PATH/AppIcon76x76@1x.png"
          sips -z 152 152 1024x1024.png --out "$APP_PATH/AppIcon76x76@2x.png"
          sips -z 167 167 1024x1024.png --out "$APP_PATH/AppIcon83.5x83.5@2x.png"

          PLIST="$APP_PATH/Info.plist"
          /usr/libexec/PlistBuddy -c "Delete :CFBundleIcons" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Delete :CFBundleIcons~ipad" "$PLIST" 2>/dev/null || true

          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon20x20" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon29x29" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon40x40" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon60x60" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon76x76" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon83.5x83.5" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons:CFBundlePrimaryIcon:UIPrerenderedIcon bool true" "$PLIST"

          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon dict" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles array" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon20x20" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon29x29" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon40x40" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon60x60" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon76x76" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:CFBundleIconFiles: string AppIcon83.5x83.5" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIcons~ipad:CFBundlePrimaryIcon:UIPrerenderedIcon bool true" "$PLIST"

          echo "Icons injected successfully!"
          ls -la "$APP_PATH"/AppIcon*.png

      # ── Fakesign with ldid for TrollStore compatibility ──
      - name: Fakesign for TrollStore
        run: |
          echo "═══ Fakesigning for TrollStore ═══"

          APP_PATH=$(find ./build -name "*.app" -path "*Release-iphoneos*" | head -1)
          echo "App path: $APP_PATH"

          # Create entitlements plist
          cat > /tmp/entitlements.plist << 'ENTXML'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>platform-application</key>
            <true/>
            <key>com.apple.private.security.no-container</key>
            <true/>
            <key>get-task-allow</key>
            <true/>
          </dict>
          </plist>
          ENTXML

          # Fakesign the main binary
          APP_NAME=$(basename "$APP_PATH" .app)
          BINARY_PATH="$APP_PATH/$APP_NAME"

          if [ -f "$BINARY_PATH" ]; then
            echo "Fakesigning binary: $BINARY_PATH"
            ldid -S/tmp/entitlements.plist "$BINARY_PATH"
            echo "Main binary signed!"
          else
            echo "Binary not found at: $BINARY_PATH"
            echo "Looking for binaries..."
            find "$APP_PATH" -type f -perm +111 | head -10
            # Try to sign whatever executable we find
            for bin in $(find "$APP_PATH" -type f -perm +111 ! -name "*.dylib" ! -name "*.png" ! -name "*.plist"); do
              echo "Fakesigning: $bin"
              ldid -S/tmp/entitlements.plist "$bin" 2>/dev/null || true
            done
          fi

          # Also fakesign any frameworks/dylibs
          find "$APP_PATH" -name "*.dylib" -o -name "*.framework" | while read fw; do
            if [ -d "$fw" ]; then
              fw_name=$(basename "$fw" .framework)
              fw_bin="$fw/$fw_name"
              if [ -f "$fw_bin" ]; then
                echo "Fakesigning framework: $fw_bin"
                ldid -S/tmp/entitlements.plist "$fw_bin" 2>/dev/null || true
              fi
            elif [ -f "$fw" ]; then
              echo "Fakesigning dylib: $fw"
              ldid -S/tmp/entitlements.plist "$fw" 2>/dev/null || true
            fi
          done

          echo "═══ Fakesigning complete ═══"

      - name: Package IPA for TrollStore
        run: |
          APP_PATH=$(find ./build -name "*.app" -path "*Release-iphoneos*" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found!"
            exit 1
          fi
          echo "Found app: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r -9 iPhoneControl_WDA.ipa Payload/
          echo "IPA size: $(du -sh iPhoneControl_WDA.ipa | cut -f1)"

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iPhoneControl-WDA
          path: iPhoneControl_WDA.ipa
          retention-days: 90
