name: Build Custom WDA IPA (with ShieldLib Protection)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build WDA IPA + ShieldLib
    runs-on: macos-14

    steps:
      - name: Checkout WebDriverAgent
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Install ldid
        run: |
          curl -sL https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid_macosx_arm64 -o /usr/local/bin/ldid
          chmod +x /usr/local/bin/ldid
          echo "ldid installed"

      # ── Build WebDriverAgentLib from modified source ──
      - name: Build WebDriverAgentLib
        run: |
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            CODE_SIGN_ENTITLEMENTS="" \
            ONLY_ACTIVE_ARCH=NO

          echo "═══ Build output ═══"
          find ./build -name "WebDriverAgentLib" -type f 2>/dev/null
          find ./build -name "WebDriverAgentRunner-Runner" -type f 2>/dev/null
          find ./build -name "WebDriverAgentRunner" -type f ! -path "*.dSYM*" 2>/dev/null

      # ══════════════════════════════════════════════════════
      # BUILD SHIELDLIB DYLIB — Hệ thống bảo vệ license
      # ══════════════════════════════════════════════════════
      - name: Build ShieldLib Protection dylib
        run: |
          echo "═══ Building ShieldLib protection dylib ═══"

          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "SDK: $SDK_PATH"

          # Compile all Swift files into a single dylib
          swiftc \
            -emit-library \
            -module-name ShieldLib \
            -target arm64-apple-ios14.0 \
            -sdk "$SDK_PATH" \
            -O \
            -Xlinker -rpath -Xlinker @executable_path/Frameworks \
            -Xlinker -rpath -Xlinker @loader_path/Frameworks \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework SystemConfiguration \
            -o ShieldLib.dylib \
            ShieldLib/Config.swift \
            ShieldLib/MZRSA.swift \
            ShieldLib/KeychainStore.swift \
            ShieldLib/Reachability.swift \
            ShieldLib/TimeLock.swift \
            ShieldLib/ServerClient.swift \
            ShieldLib/LicenseManager.swift \
            ShieldLib/ShieldEntry.swift

          # Set install name to match the LC_LOAD_DYLIB in the main binary
          install_name_tool -id @executable_path/hhhhsd.dylib ShieldLib.dylib

          echo "ShieldLib.dylib built successfully!"
          ls -lh ShieldLib.dylib
          file ShieldLib.dylib

          # Verify install name
          otool -L ShieldLib.dylib | head -5

      # ── Patch the base IPA with new WebDriverAgentLib + ShieldLib ──
      - name: Patch Base IPA
        run: |
          echo "═══ Patching base IPA with auth-enabled WebDriverAgentLib + ShieldLib ═══"

          # Check base IPA exists
          if [ ! -f "base/iPhoneControl.ipa" ]; then
            echo "ERROR: base/iPhoneControl.ipa not found!"
            echo "Please upload the working IPA to the 'base/' folder in the repo"
            exit 1
          fi

          # Extract base IPA
          mkdir -p work
          cd work
          unzip -o ../base/iPhoneControl.ipa
          echo "Base IPA extracted"

          APP_DIR="Payload/WebDriverAgentRunner-Runner.app"

          # ── Replace WebDriverAgentLib ──
          NEW_LIB=$(find ../build -name "WebDriverAgentLib" -path "*/WebDriverAgentLib.framework/*" -type f | head -1)
          if [ -z "$NEW_LIB" ]; then
            echo "ERROR: Built WebDriverAgentLib not found!"
            find ../build -name "WebDriverAgentLib*" -type f
            exit 1
          fi
          echo "New WebDriverAgentLib: $NEW_LIB ($(du -sh "$NEW_LIB" | cut -f1))"

          OLD_LIB="$APP_DIR/PlugIns/WebDriverAgentRunner.xctest/Frameworks/WebDriverAgentLib.framework/WebDriverAgentLib"
          if [ ! -f "$OLD_LIB" ]; then
            echo "ERROR: WebDriverAgentLib not found in base IPA!"
            find Payload -name "WebDriverAgentLib" -type f
            exit 1
          fi
          echo "Old WebDriverAgentLib: $(du -sh "$OLD_LIB" | cut -f1)"

          cp "$NEW_LIB" "$OLD_LIB"
          echo "WebDriverAgentLib REPLACED with auth-enabled version!"

          # ── Replace WebDriverAgentRunner ──
          NEW_RUNNER=$(find ../build -name "WebDriverAgentRunner" -path "*/WebDriverAgentRunner.xctest/*" -type f ! -path "*.dSYM*" | head -1)
          OLD_RUNNER="$APP_DIR/PlugIns/WebDriverAgentRunner.xctest/WebDriverAgentRunner"
          if [ -n "$NEW_RUNNER" ] && [ -f "$OLD_RUNNER" ]; then
            cp "$NEW_RUNNER" "$OLD_RUNNER"
            echo "WebDriverAgentRunner REPLACED"
          fi

          # ══════════════════════════════════════════════════
          # INJECT SHIELDLIB — thay thế hhhhsd.dylib gốc
          # ══════════════════════════════════════════════════
          echo ""
          echo "═══ Injecting ShieldLib protection ═══"
          cp ../ShieldLib.dylib "$APP_DIR/hhhhsd.dylib"
          echo "ShieldLib.dylib → hhhhsd.dylib INJECTED!"
          ls -lh "$APP_DIR/hhhhsd.dylib"

          # Inject custom icon if available
          if [ -f "../1024x1024.png" ]; then
            echo "Injecting custom icon..."
            sips -z 120 120 ../1024x1024.png --out "$APP_DIR/icon.png" 2>/dev/null
            echo "Icon replaced!"
          fi

          # ══════════════════════════════════════════════════
          # FAKESIGN ALL BINARIES
          # ══════════════════════════════════════════════════
          echo ""
          echo "═══ Fakesigning all binaries ═══"

          cat > /tmp/ent.plist << 'XMLEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>platform-application</key>
            <true/>
            <key>com.apple.private.security.no-container</key>
            <true/>
            <key>get-task-allow</key>
            <true/>
            <key>keychain-access-groups</key>
            <array>
              <string>com.icontrol.shield</string>
            </array>
          </dict>
          </plist>
          XMLEOF

          # Sign main binary
          MAIN_BIN="$APP_DIR/WebDriverAgentRunner-Runner"
          if [ -f "$MAIN_BIN" ]; then
            ldid -S/tmp/ent.plist "$MAIN_BIN"
            echo "Signed: WebDriverAgentRunner-Runner"
          fi

          # Sign all dylibs (including hhhhsd.dylib = ShieldLib)
          find "$APP_DIR" -name "*.dylib" -type f | while read f; do
            ldid -S/tmp/ent.plist "$f" 2>/dev/null && echo "Signed: $(basename $f)" || true
          done

          # Sign xctest binary
          if [ -f "$OLD_RUNNER" ]; then
            ldid -S/tmp/ent.plist "$OLD_RUNNER"
            echo "Signed: WebDriverAgentRunner (xctest)"
          fi

          # Sign WebDriverAgentLib
          ldid -S/tmp/ent.plist "$OLD_LIB"
          echo "Signed: WebDriverAgentLib"

          # Sign framework binaries
          find "$APP_DIR" -path "*/Frameworks/*.framework/*" -type f ! -name "*.plist" ! -name "CodeResources" | while read f; do
            ldid -S/tmp/ent.plist "$f" 2>/dev/null && echo "Signed: $(basename $f)" || true
          done

          echo ""
          echo "═══ Final IPA contents ═══"
          find Payload -type f | sort

          # Package final IPA
          zip -r -9 ../iPhoneControl_WDA.ipa Payload/
          cd ..
          echo ""
          echo "═══ DONE ═══"
          echo "IPA size: $(du -sh iPhoneControl_WDA.ipa | cut -f1)"

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iPhoneControl-WDA
          path: iPhoneControl_WDA.ipa
          retention-days: 90
